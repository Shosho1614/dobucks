<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dobucks â€” Water Sort Puzzle</title>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<style>
/* Ø£Ù†Ù…Ø§Ø· CSS ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± */
:root{
  --tube-width:45.9px; --tube-height:137.7px; --liquid-height:27.54px;
  --tube-border:#0f3460; --bg1:#0c0a1f; --bg2:#1a1738; --bg3:#141229;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Segoe UI, Tahoma, Arial;color:#fff;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));}
button{cursor:pointer;border:none;border-radius:999px;padding:8px 14px;font-weight:700;transition:all .2s;background:linear-gradient(135deg,#4361ee,#3a0ca3);color:#fff;}
button:hover:not(:disabled){transform:scale(1.05);}
button:disabled{background:#555;cursor:not-allowed;}
h2,h3{margin-bottom:10px;text-align:center;}

.screen{width:100%;max-width:500px;margin-top:40px;padding:20px;background:rgba(255,255,255,0.1);border-radius:12px;display:none;flex-direction:column;align-items:center;gap:12px;color:#fff;}
.screen.active{display:flex;}
input{width:90%;padding:10px;border-radius:8px;border:none;font-size:1rem;margin-bottom:8px;background:rgba(255,255,255,0.9);}

#game-wrap{width:100%;max-width:1100px;display:none;flex-direction:column;align-items:center;}

.game-info{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.15);padding:13.8px; border-radius:11.5px; margin-bottom:20.7px; width:90%;color:#fff; transform: scale(1.15); transform-origin: top center;}
.stats{display:flex;gap:20.7px; align-items:center;}
.stat-value{font-size:1.84rem; color:#4cc9f0;font-weight:700;}
.stat-label{font-size:1.035rem; color:#cbd5e1;}
.controls{display:flex;gap:11.5px; font-size: 1rem; flex-wrap: nowrap;}
.game-area{display:flex;flex-wrap:wrap;gap:18px;justify-content:center;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.1), transparent);border-radius:12px;}
.tube{width:var(--tube-width);height:var(--tube-height);background:rgba(255,255,255,0.15);border:3px solid var(--tube-border);border-top:none;border-radius:0 0 18px 18px;position:relative;display:flex;flex-direction:column-reverse;overflow:hidden;cursor:pointer;transition:transform .18s, box-shadow .18s, background .18s;box-shadow: inset 0 -4px 10px rgba(0,0,0,0.3);}
.tube:hover{transform:translateY(-6px);box-shadow:0 6px 28px rgba(76,201,240,0.25);}
.tube.selected{transform:translateY(-12px);box-shadow:0 8px 32px rgba(76,201,240,0.45);}
.liquid{height:var(--liquid-height);width:100%;transition:height .28s,opacity .28s;border-radius:0;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;}
.hidden-liquid{background-color:#000!important;color:white;}
.message{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(2,6,23,0.9);padding:20px;border-radius:12px;display:none;flex-direction:column;align-items:center;gap:10px;color:#fff;}

#main-screen .main-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
  max-width: 300px;
}

#main-screen .main-buttons button {
  width: 100%;
  padding: 12px;
  font-size: 1.1rem;
}

.back-to-main-btn {
  background: linear-gradient(135deg, #f72585, #b5179e) !important;
  margin-left: 0;
}

#notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 25px;
    background-color: #333;
    color: #fff;
    font-weight: bold;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: none;
    z-index: 9999;
    min-width: 270px;
    text-align: center;
    font-family: 'Segoe UI', Tahoma, Arial;
    font-size: 15px;
    transition: all 0.4s ease;
}

/* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª */
#internet-check {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
    text-align: center;
    padding: 20px;
}

#internet-check h2 {
    font-size: 2rem;
    margin-bottom: 20px;
    color: #ff6b6b;
}

#internet-check p {
    font-size: 1.2rem;
    margin-bottom: 30px;
    max-width: 500px;
}

#internet-check button {
    background: linear-gradient(135deg, #4cc9f0, #4361ee);
    padding: 12px 24px;
    font-size: 1.1rem;
}

.referral-system-container {
  background: rgba(255,255,255,0.1);
  padding: 20px;
  border-radius: 12px;
  margin: 15px 0;
  width: 100%;
  color: #fff;
}

.referral-input-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 15px 0;
}

.referral-link-container {
  margin: 15px 0;
}

.referral-link {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  background: rgba(255,255,255,0.1);
  color: white;
  border: none;
  margin-bottom: 10px;
  text-align: center;
  font-weight: bold;
}

.withdrawal-methods {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin: 15px 0;
}

.withdrawal-method {
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 15px;
  text-align: center;
  width: 140px;
  cursor: pointer;
  transition: all 0.3s;
  color: #fff;
}

.withdrawal-method:hover {
  background: rgba(255,255,255,0.15);
  transform: translateY(-5px);
}

.withdrawal-method.selected {
  background: rgba(76, 201, 240, 0.2);
  border: 2px solid #4cc9f0;
}

.withdrawal-form {
  width: 100%;
  margin-top: 15px;
}

.withdrawal-form input {
  width: 100%;
  margin-bottom: 10px;
}

.withdrawal-conditions {
  background: rgba(255,255,255,0.1);
  padding: 15px;
  border-radius: 10px;
  margin: 15px 0;
  text-align: center;
  color: #fff;
}

.withdrawal-conditions ul {
  text-align: right;
  margin: 10px 0;
  padding-right: 20px;
}

.withdrawal-conditions li {
  margin-bottom: 8px;
}

.status-box {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  padding: 15px;
  margin-top: 15px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  width: 100%;
  color: #fff;
}

.table-container {
  margin-top: 20px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  padding: 10px;
  width: 100%;
  color: #fff;
}

table {
  width: 100%;
  border-collapse: collapse;
  text-align: center;
}

table th, table td {
  padding: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

table th {
  background: rgba(15, 52, 96, 0.5);
  color: white;
}

.alert {
  background: rgba(255, 234, 167, 0.2);
  color: #f1c40f;
  border-radius: 8px;
  padding: 10px;
  margin: 10px 0;
  text-align: center;
  display: none;
  width: 100%;
}

.msg {
  text-align:center;
  margin-top:10px;
  font-weight:bold;
  width: 100%;
  color: #fff;
}

.withdrawal-quick-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin: 15px 0;
}

.withdrawal-quick-btn {
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 12px;
  text-align: center;
  width: 140px;
  cursor: pointer;
  transition: all 0.3s;
  border: none;
  color: white;
  font-weight: bold;
}

.withdrawal-quick-btn:hover {
  background: rgba(255,255,255,0.15);
  transform: translateY(-3px);
}

.custom-prompt {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

.custom-prompt-content {
  background: linear-gradient(135deg, #1e3c72, #2a5298);
  padding: 25px;
  border-radius: 15px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  text-align: center;
  animation: fadeIn 0.3s ease;
  color: #fff;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.custom-prompt h3 {
  margin-bottom: 15px;
  color: white;
  font-size: 1.3rem;
}

.custom-prompt input {
  width: 100%;
  padding: 12px;
  margin: 15px 0;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.1);
  color: white;
  font-size: 1rem;
}

.custom-prompt input::placeholder {
  color: rgba(255,255,255,0.6);
}

.custom-prompt-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 15px;
}

.custom-prompt-btn {
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  min-width: 100px;
}

.custom-prompt-cancel {
  background: rgba(255,255,255,0.1);
  color: white;
}

.custom-prompt-cancel:hover {
  background: rgba(255,255,255,0.2);
}

.custom-prompt-ok {
  background: linear-gradient(135deg, #4cc9f0, #4361ee);
  color: white;
}

.custom-prompt-ok:hover {
  background: linear-gradient(135deg, #3aa8d0, #3250d4);
  transform: translateY(-2px);
}

.referral-item {
  background: rgba(255,255,255,0.1);
  padding: 12px;
  margin: 8px 0;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s;
  color: #fff;
}

.referral-item:hover {
  background: rgba(255,255,255,0.15);
  transform: translateX(5px);
}

.referral-code-display {
  font-family: monospace;
  letter-spacing: 2px;
  font-size: 1.1rem;
  color: #4cc9f0;
}

.referral-stats {
  display: flex;
  justify-content: space-around;
  width: 100%;
  margin: 15px 0;
  background: rgba(255,255,255,0.1);
  padding: 15px;
  border-radius: 10px;
  color: #fff;
}

.stat-card {
  text-align: center;
  padding: 10px;
}

.stat-number {
  font-size: 1.8rem;
  font-weight: bold;
  color: #4cc9f0;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.9rem;
  color: rgba(255,255,255,0.7);
}

#main-container {
  transform: scale(0.95);
  transform-origin: top center;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}

@media (max-width:700px){
  :root{--tube-width:38.25px;--tube-height:114.75px;--liquid-height:22.95px;}
  .controls {
    flex-wrap: nowrap;
    justify-content: center;
  }
  .back-to-main-btn {
    margin-left: 0;
    margin-top: 0;
  }
  #notification {
    min-width: 250px;
    padding: 12px 20px;
    font-size: 14px;
  }
  .withdrawal-method, .withdrawal-quick-btn {
    width: 120px;
  }
  .referral-stats {
    flex-direction: column;
    gap: 10px;
  }
  .custom-prompt-content {
    width: 95%;
    padding: 20px;
  }
  
  .game-info {
    flex-direction: column;
    gap: 10px;
  }
  
  .controls {
    width: 100%;
    justify-content: space-between;
  }
  
  #internet-check h2 {
    font-size: 1.5rem;
  }
  
  #internet-check p {
    font-size: 1rem;
  }
}

/* Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
.notif {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #4caf50;
  color: white;
  padding: 10px 20px;
  border-radius: 12px;
  z-index: 9999;
  font-size: 14px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.notif.success { background: #4caf50; }
.notif.error { background: #f44336; }
.notif.info { background: #2196f3; }
</style>
</head>
<body>
<!-- ======== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ======== -->
<div id="internet-check">
  <h2>âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</h2>
  <p>ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.</p>
  <button id="retry-connection">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµØºÙŠØ± -->
<div id="main-container">
<!-- ======== Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ© ======== -->
<div id="notification"></div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø­Ø³Ù†Ø© -->
<div id="custom-prompt" class="custom-prompt">
  <div class="custom-prompt-content">
    <h3 id="prompt-title">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</h3>
    <input type="text" id="prompt-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‡Ù†Ø§">
    <div class="custom-prompt-buttons">
      <button id="prompt-cancel" class="custom-prompt-btn custom-prompt-cancel">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="prompt-ok" class="custom-prompt-btn custom-prompt-ok">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ù„Ø¹Ø¨Ø© -->
<div class="screen active" id="main-screen">
  <h2>ğŸ® Dobucks</h2>
  <div class="main-buttons">
    <button id="start-game">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
    <button id="referral-btn">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</button>
    <button id="withdraw-btn">Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯</button>
    <button id="referral-system-btn">Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø¥Ø­Ø§Ù„Ø©</button>
  </div>
  
  <!-- Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <div class="status-box">
    <h3>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
    <div class="stat-value" id="main-screen-balance">0</div>
    <div class="stat-label">Ù†Ù‚Ø·Ø©</div>
  </div>
</div>

<!-- ===================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ===================== -->

<!-- Ø´Ø§Ø´Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø© -->
<div class="screen" id="referral-screen">
  <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</h2>
  <p>Ø´Ø§Ø±Ùƒ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦ÙƒØŒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ <strong>50 Ù†Ù‚Ø·Ø©</strong> Ø¹Ù† ÙƒÙ„ ØµØ¯ÙŠÙ‚ ÙŠØ³ØªØ®Ø¯Ù…Ù‡ ğŸ</p>
  
  <div class="referral-stats">
    <div class="stat-card">
      <div class="stat-number" id="total-referrals">0</div>
      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="referral-bonus">0</div>
      <div class="stat-label">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©</div>
    </div>
  </div>

  <div style="margin-top:20px; width:100%;">
    <h3>Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø©</h3>
    <div id="referrals-list" style="max-height: 200px; overflow-y: auto;">
      <div class="referral-item">
        <span>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø§Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</span>
      </div>
    </div>
  </div>

  <button id="back-to-main">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<!-- Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© -->
<div class="screen" id="referral-system-screen">
  <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø¥Ø­Ø§Ù„Ø© ğŸ”—</h2>
  
  <div class="referral-system-container">
    <div id="userSection">
      <div class="referral-input-group">
        <input type="text" id="ref-name" placeholder="Ø§Ø³Ù…Ùƒ">
        <input type="email" id="ref-email" placeholder="Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <button onclick="createReferralLink()">ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø¥Ø­Ø§Ù„Ø©</button>
      </div>
    </div>

    <div id="refSection" style="display:none;">
      <p>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
      <div class="referral-link-container">
        <textarea id="refLink" class="referral-link" readonly></textarea>
      </div>
      <button onclick="copyReferralLink()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
    </div>

    <div id="refResult" style="display:none;">
      <h3>ğŸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ø­Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!</h3>
    </div>
  </div>

  <button id="back-to-main-from-referral">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<!-- Ø´Ø§Ø´Ø© Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ø³Ù†Ø© -->
<div class="screen" id="withdrawal-screen">
  <h2>Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ ğŸ’°</h2>
  
  <div class="withdrawal-conditions">
    <h3>Ø´Ø±ÙˆØ· Ø§Ù„Ø³Ø­Ø¨:</h3>
    <ul>
      <li>Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 2000 Ù†Ù‚Ø·Ø©</li>
      <li>3 Ø¥Ø­Ø§Ù„Ø§Øª Ù†Ø§Ø¬Ø­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</li>
      <li>Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ 50 ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰</li>
      <li>Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ù…Ø¹Ù„Ù‚Ø©</li>
    </ul>
    <p>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="current-balance">0</span> Ù†Ù‚Ø·Ø©</p>
    <p>Ø¹Ø¯Ø¯ Ø¥Ø­Ø§Ù„Ø§ØªÙƒ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©: <span id="referrals-count">0</span></p>
    <p>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="current-level">1</span></p>
  </div>
  
  <!-- Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø³Ø­Ø¨ - Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø¨Ø§ÙŠÙŠØ± Ùˆ Ø¨Ø§ÙŠÙ†Ø§Ù†Ø³ -->
  <div class="withdrawal-quick-buttons">
    <button class="withdrawal-quick-btn" onclick="requestQuickWithdrawal('ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´', 20)">ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</button>
    <button class="withdrawal-quick-btn" onclick="requestQuickWithdrawal('Ø§ØªØµØ§Ù„Ø§Øª ÙƒØ§Ø´', 20)">Ø§ØªØµØ§Ù„Ø§Øª ÙƒØ§Ø´</button>
    <button class="withdrawal-quick-btn" onclick="requestQuickWithdrawal('Ø£ÙˆØ±Ø§Ù†Ø¬ ÙƒØ§Ø´', 20)">Ø£ÙˆØ±Ø§Ù†Ø¬ ÙƒØ§Ø´</button>
    <button class="withdrawal-quick-btn" onclick="requestQuickWithdrawal('ÙˆÙŠ Ø¨Ø§ÙŠ', 20)">ÙˆÙŠ Ø¨Ø§ÙŠ</button>
    <button class="withdrawal-quick-btn" onclick="requestQuickWithdrawal('Ø¨Ø§ÙŠÙŠØ±', 20)">Ø¨Ø§ÙŠÙŠØ±</button>
    <button class="withdrawal-quick-btn" onclick="requestQuickWithdrawal('Ø¨Ø§ÙŠÙ†Ø§Ù†Ø³', 20)">Ø¨Ø§ÙŠÙ†Ø§Ù†Ø³</button>
  </div>
  
  <p id="msg" class="msg"></p>
  
  <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ -->
  <div id="withdraw-status" class="status-box">
    ğŸ“­ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.
  </div>
  
  <!-- Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª -->
  <div id="withdraw-history" class="table-container" style="display:none;">
    <h3 style="text-align:center; color:#4cc9f0;">ğŸ“œ Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
    <table id="history-table">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
          <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <div id="alert-box" class="alert"></div>
  
  <!-- ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù‚Ø³Ù… withdrawal-methods Ùˆ withdrawal-form -->
  
  <button id="back-to-main-from-withdrawal">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
<div id="game-wrap">
  <div class="game-info">
    <div class="stats">
      <div><div class="stat-value" id="level">1</div><div class="stat-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div></div>
      <div><div class="stat-value" id="points">0</div><div class="stat-label">Ø§Ù„Ù†Ù‚Ø§Ø·</div></div>
    </div>
    <div class="controls">
      <button id="undo-btn" disabled>â†¶ ØªØ±Ø§Ø¬Ø¹</button>
      <button id="restart-btn">â†» Ø¥Ø¹Ø§Ø¯Ø©</button>
      <!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <button id="back-to-main-from-game" class="back-to-main-btn">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>
  </div>
  <div class="game-area" id="game-area"></div>
</div>

<!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙÙˆØ² -->
<div class="message" id="win-message">
  <h3>ğŸ‰ Ø£Ø­Ø³Ù†Øª! Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h3>
  <p id="win-stats"></p>
  <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
    <button id="continue-btn">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</button>
    <button id="close-win">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>
</div> <!-- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->

<script>
// ========= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Baserow =========
const BASEROW_API_TOKEN = "yiLf7FjjfI0xxwocyQgpYL77ASbuXSeI";
const BASEROW_USERS_URL = "https://api.baserow.io/api/database/rows/table/692997/"; // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

// ======== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Baserow Ø§Ù„Ø£Ø®Ø±Ù‰ ========
const BASEROW_API_URL = "https://api.baserow.io/api/database/rows/table/693348";
const BASEROW_REFERRAL_URL = "https://api.baserow.io/api/database/rows/table/693464/"; // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
const BASEROW_WITHDRAW_URL = "https://api.baserow.io/api/database/rows/table/693458/";

// ======== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª EmailJS ========
emailjs.init("G6hrIA85mOgaFmKrr");
const SERVICE_ID = "service_dobucks";
const TEMPLATE_ID = "template_lhlxcjf";

// ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª EmailJS Ù„Ù„Ø³Ø­Ø¨ ======
const EMAILJS_SERVICE_ID = "service_dobucks";
const EMAILJS_TEMPLATE_ID = "template_withdraw";

// ======== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù„Ø¹Ø¨Ø© ========
let currentUser = null;
let gameProgress = {
  level: 1,
  balance: 0,
  totalPoints: 0
};

// ======== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ========
const COLORS = ['#FF0000','#FF7F00','#FFFF00','#00FF00','#0000FF','#4B0082','#9400D3','#FF1493','#00FFFF','#FFD700','#FF69B4','#32CD32'];
const MAX_DAILY_POINTS = 80;
const REFERRAL_BONUS = 50;
const GAME_NAME = "Water Sort Puzzle";
const MAX_REFERRALS_PER_DAY = 5;
const WITHDRAW_FEE = 2;
const TODAY = new Date().toISOString().split("T")[0];
const MIN_WITHDRAW_POINTS = 2000;

// ======== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ========
let dailyPoints = 0;
let gameHistory = [];
let lastKnownStatus = "";

// Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
const gameState = {
  level: 1,
  moves: 0,
  tubes: [],
  selectedTube: null,
  history: [],
  isAnimating: false
};

// ========= Ø­ÙØ¸ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ =========
function saveUserLocal(user) {
  localStorage.setItem("dobucks_user", JSON.stringify(user));
}

function loadUserLocal() {
  return JSON.parse(localStorage.getItem("dobucks_user")) || null;
}

// ========= Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Baserow =========
async function saveUserToBaserow(user) {
  try {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ù‹Ø§
    const response = await fetch(`${BASEROW_USERS_URL}?user_email=${encodeURIComponent(user.email)}`, {
      headers: { "Authorization": `Token ${BASEROW_API_TOKEN}` }
    });
    const data = await response.json();

    // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ø­Ø¯Ø« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
    if (data?.results?.length > 0) {
      const existing = data.results[0];
      await fetch(`${BASEROW_USERS_URL}${existing.id}/`, {
        method: "PATCH",
        headers: {
          "Authorization": `Token ${BASEROW_API_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          level: user.level,
          points: user.points,
          referrals: user.referrals,
          balance: user.balance,
          last_update: new Date().toISOString()
        })
      });
    } else {
      // Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ø¶ÙŠÙÙ‡ Ø¬Ø¯ÙŠØ¯
      await fetch(BASEROW_USERS_URL, {
        method: "POST",
        headers: {
          "Authorization": `Token ${BASEROW_API_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          user_email: user.email,
          username: user.name,
          level: user.level,
          points: user.points,
          referrals: user.referrals,
          balance: user.balance,
          last_update: new Date().toISOString()
        })
      });
    }
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Baserow:", err);
  }
}

// ========= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Baserow =========
async function loadUserFromBaserow(email) {
  try {
    const response = await fetch(`${BASEROW_USERS_URL}?user_email=${encodeURIComponent(email)}`, {
      headers: { "Authorization": `Token ${BASEROW_API_TOKEN}` }
    });
    const data = await response.json();
    if (data?.results?.length > 0) return data.results[0];
  } catch (err) {
    console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Baserow:", err);
  }
  return null;
}

// ========= Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ø¹Ù†Ø¯ Ø§Ø¬ØªÙŠØ§Ø² Ù…Ø³ØªÙˆÙ‰ =========
function addPointsForLevelCompletion() {
  let user = loadUserLocal();
  if (!user) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
    user = {
      email: "guest_" + Date.now() + "@dobucks.local",
      name: "Ø¶ÙŠÙ",
      level: 1,
      points: 0,
      referrals: 0,
      balance: 0,
      last_update: new Date().toISOString()
    };
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„Ù†Ù‚Ø§Ø· - Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
  user.level = (user.level || 1) + 1;
  user.points = (user.points || 0) + 1;
  user.balance = (user.balance || 0) + 1;
  user.last_update = new Date().toISOString();

  saveUserLocal(user);
  saveUserToBaserow(user);
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
  if (currentUser) {
    currentUser.level = user.level;
    currentUser.balance = user.balance;
  }
  
  gameState.level = user.level;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  updateGameUI();
  updateLevelAndPoints(user.balance, user.level);

  showNotification(`ğŸ‰ Ø§Ø¬ØªØ²Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${user.level - 1}! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø©!`, "success");
  
  // Ø­ÙØ¸ ÙÙŠ localStorage Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ Ù„Ù„ØªØ£ÙƒØ¯
  localStorage.setItem("current_level", user.level);
  localStorage.setItem("user_balance", user.balance);
}

// ====== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ø±ÙˆØ· Ø§Ù„Ø³Ø­Ø¨ ======
function canWithdraw(user) {
  if (!user) return { ok: false, reason: "ÙŠØ¬Ø¨ ØªØ­Ù‚Ù‚ Ø´Ø±ÙˆØ· Ø§Ù„Ø³Ø­Ø¨ Ø­ØªÙ‰ ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­" };
  if ((user.balance || 0) < 2000) return { ok: false, reason: "ÙŠØ¬Ø¨ ØªØ­Ù‚Ù‚ Ø´Ø±ÙˆØ· Ø§Ù„Ø³Ø­Ø¨ Ø­ØªÙ‰ ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­" };
  if ((user.referrals || 0) < 3) return { ok: false, reason: "ÙŠØ¬Ø¨ ØªØ­Ù‚Ù‚ Ø´Ø±ÙˆØ· Ø§Ù„Ø³Ø­Ø¨ Ø­ØªÙ‰ ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­" };
  if ((user.level || 0) < 50) return { ok: false, reason: "ÙŠØ¬Ø¨ ØªØ­Ù‚Ù‚ Ø´Ø±ÙˆØ· Ø§Ù„Ø³Ø­Ø¨ Ø­ØªÙ‰ ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­" };
  if (user.hasPendingWithdrawal) return { ok: false, reason: "ÙŠØ¬Ø¨ ØªØ­Ù‚Ù‚ Ø´Ø±ÙˆØ· Ø§Ù„Ø³Ø­Ø¨ Ø­ØªÙ‰ ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­" };
  return { ok: true };
}

// ====== Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ======
async function requestWithdrawal(method, details) {
  const amount = 2000; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø³Ø­Ø¨
  const check = canWithdraw(currentUser);

  if (!check.ok) {
    showNotification(check.reason, "error");
    return false;
  }

  try {
    // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    currentUser.balance -= amount;
    currentUser.hasPendingWithdrawal = true;
    saveUserData();

    const withdrawalData = {
      user_name: currentUser.name || "Ù„Ø§Ø¹Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„",
      withdrawal_method: method,
      withdrawal_details: details,
      amount_requested: amount,
      status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
      date_requested: new Date().toISOString()
    };

    // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Baserow
    const response = await fetch(BASEROW_WITHDRAW_URL, {
      method: "POST",
      headers: {
        "Authorization": `Token ${BASEROW_API_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(withdrawalData)
    });

    if (!response.ok) throw new Error("Baserow Error");

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„Ù‰ Gmail Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
    await sendEmailToAdmin(withdrawalData);

    showNotification("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.", "success");
    return true;

  } catch (err) {
    console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨:", err);
    showNotification("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.", "error");
    return false;
  }
}

// ====== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ù„Ù‰ Gmail ======
async function sendEmailToAdmin(data) {
  try {
    const params = {
      to_email: "dobucksapp@gmail.com",
      subject: `Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${data.user_name}`,
      message: `
ğŸ“© ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨:
- Ø§Ù„Ø§Ø³Ù…: ${data.user_name}
- Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: ${data.withdrawal_method}
- Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${data.withdrawal_details}
- Ø§Ù„Ù…Ø¨Ù„Øº: ${data.amount_requested}
- Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleString()}
      `
    };

    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
    console.log("ğŸ“§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.");
  } catch (err) {
    console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯:", err);
  }
}

// ====== Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ======
function handleReferralParameter() {
  const urlParams = new URLSearchParams(window.location.search);
  const refCode = urlParams.get("ref");

  if (refCode) {
    showNotification(`ğŸ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­: ${refCode}`, "success", 4000);
    applyReferral(refCode);
  }
}

// ====== ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ======
async function applyReferral(refCode) {
  if (localStorage.getItem("referral_used")) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±

  try {
    const bonusPoints = 50;
    let userBalance = parseInt(localStorage.getItem("user_balance") || "0");
    userBalance += bonusPoints;
    localStorage.setItem("user_balance", userBalance);
    localStorage.setItem("referral_used", refCode);

    await fetch(BASEROW_REFERRAL_URL, {
      method: "POST",
      headers: {
        "Authorization": `Token ${BASEROW_API_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        ref_code: refCode,
        points_awarded: bonusPoints,
        date: new Date().toISOString()
      })
    });

    showNotification("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!", "success");
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª
    updateLevelAndPoints();
  } catch (err) {
    console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©:", err);
    showNotification("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©", "error");
  }
}

// ====== Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ======
function createReferralLink() {
  const name = document.getElementById("ref-name").value.trim();
  const email = document.getElementById("ref-email").value.trim();

  if (!name || !email) {
    showNotification("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", "error");
    return;
  }

  const refCode = "DOB-" + name.replace(/\s+/g, "").substring(0, 4).toUpperCase() + Math.floor(Math.random() * 1000);
  const refLink = `${window.location.origin}?ref=${refCode}`;

  document.getElementById("refLink").value = refLink;
  document.getElementById("userSection").style.display = "none";
  document.getElementById("refSection").style.display = "block";

  localStorage.setItem("my_ref_code", refCode);

  fetch(BASEROW_REFERRAL_URL, {
    method: "POST",
    headers: {
      "Authorization": `Token ${BASEROW_API_TOKEN}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      user_name: name,
      user_email: email,
      ref_code: refCode,
      date: new Date().toISOString()
    })
  });
}

// ====== Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ======
function copyReferralLink() {
  const refLink = document.getElementById("refLink");
  refLink.select();
  document.execCommand("copy");
  showNotification("ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!", "success");
}

// ============ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¹Ù†Ø¯ Ø§Ù„ÙÙˆØ² ============
function levelCompleted() {
  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· - Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
  addPointsForLevelCompletion();
}

// ============ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙŠ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª ============
function updateLevelAndPoints(balance = null, level = null) {
  if (balance === null) balance = parseInt(localStorage.getItem("user_balance") || "0");
  if (level === null) level = parseInt(localStorage.getItem("current_level") || "1");

  console.log("Updating display - Balance:", balance, "Level:", level); // Ù„Ù„Øª Debug

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
  const pointsElements = document.querySelectorAll("#points, #main-screen-balance, #current-balance");
  pointsElements.forEach(el => {
    if (el) el.textContent = balance;
  });

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
  const levelElements = document.querySelectorAll("#level, #current-level");
  levelElements.forEach(el => {
    if (el) el.textContent = level;
  });

  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø´Ø§Ø´Ø© Ù…ÙØªÙˆØ­Ø©
  if (currentUser && currentUser.referrals) {
    const referralsCount = currentUser.referrals.length;
    document.getElementById('referrals-count').textContent = referralsCount;
    document.getElementById('total-referrals').textContent = referralsCount;
  }
}

// ======== ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª ========
function updatePointsDisplay() {
  // Ø§Ø³ØªØ¨Ø¯Ù„Ù†Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ù€ updateLevelAndPoints
  updateLevelAndPoints();
}

// ======== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ========
function checkInternet() {
  if (!navigator.onLine) {
    showInternetError();
    return false;
  }
  return true;
}

function showInternetError() {
  document.getElementById('internet-check').style.display = 'flex';
  document.getElementById('main-container').style.display = 'none';
}

function hideInternetError() {
  document.getElementById('internet-check').style.display = 'none';
  document.getElementById('main-container').style.display = 'flex';
}

// ======== Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø­Ø³Ù†Ø© ========
let promptResolve = null;

function showCustomPrompt(title, placeholder = "Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‡Ù†Ø§") {
  return new Promise((resolve) => {
    document.getElementById('prompt-title').textContent = title;
    document.getElementById('prompt-input').placeholder = placeholder;
    document.getElementById('prompt-input').value = '';
    
    const promptElement = document.getElementById('custom-prompt');
    promptElement.style.display = 'flex';
    
    promptResolve = resolve;
    
    setTimeout(() => {
      document.getElementById('prompt-input').focus();
    }, 300);
  });
}

function closeCustomPrompt() {
  document.getElementById('custom-prompt').style.display = 'none';
  promptResolve = null;
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
document.getElementById('prompt-ok').addEventListener('click', () => {
  const value = document.getElementById('prompt-input').value.trim();
  if (promptResolve) {
    promptResolve(value);
    closeCustomPrompt();
  }
});

document.getElementById('prompt-cancel').addEventListener('click', () => {
  if (promptResolve) {
    promptResolve(null);
    closeCustomPrompt();
  }
});

document.getElementById('prompt-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('prompt-ok').click();
  }
});

document.getElementById('custom-prompt').addEventListener('click', (e) => {
  if (e.target.id === 'custom-prompt') {
    if (promptResolve) {
      promptResolve(null);
      closeCustomPrompt();
    }
  }
});

// ======== ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† LocalStorage ========
function loadGameProgress() {
  const saved = localStorage.getItem('dobucks_progress');
  if (!saved) return false;
  try {
    gameProgress = JSON.parse(saved);
    return true;
  } catch (e) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø¯Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©:", e);
    return false;
  }
}

// ======== Ø­ÙØ¸ ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ========
function saveGameProgress() {
  localStorage.setItem('dobucks_progress', JSON.stringify(gameProgress));
  syncProgressToBaserow();
}

// ======== Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ‚Ø¯Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø¹ Baserow ========
async function syncProgressToBaserow() {
  if (!currentUser) return;

  const payload = {
    email: currentUser.email,
    level: gameProgress.level,
    balance: gameProgress.balance,
    totalPoints: gameProgress.totalPoints
  };

  try {
    const response = await fetch(BASEROW_API_URL + "?filter__email=" + encodeURIComponent(currentUser.email), {
      headers: { "Authorization": "Token " + BASEROW_API_TOKEN }
    });
    const data = await response.json();

    if (data.results && data.results.length > 0) {
      const rowId = data.results[0].id;
      await fetch(BASEROW_API_URL + rowId + "/", {
        method: "PATCH",
        headers: {
          "Authorization": "Token " + BASEROW_API_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
    } else {
      await fetch(BASEROW_API_URL, {
        method: "POST",
        headers: {
          "Authorization": "Token " + BASEROW_API_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
    }

    console.log("âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ‚Ø¯Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø¹ Baserow");
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ‚Ø¯Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©:", error);
  }
}

// ======== Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ EmailJS ========

// âœ… ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø¢Ø®Ø± Ø·Ù„Ø¨ + Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
async function loadWithdrawalStatus(showAlert = false) {
  const statusBox = document.getElementById("withdraw-status");
  const historyDiv = document.getElementById("withdraw-history");
  const historyTable = document.querySelector("#history-table tbody");

  try {
    statusBox.innerHTML = "ğŸ“­ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
    historyDiv.style.display = "none";
    
  } catch (err) {
    console.error(err);
    statusBox.innerHTML = "ğŸ“­ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
  }
}

// âœ… Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
function showNotification(text) {
  const alertBox = document.getElementById("alert-box");
  alertBox.innerHTML = text;
  alertBox.style.display = "block";
  setTimeout(() => alertBox.style.display = "none", 7000);
}

// ======== Ø³Ø­Ø¨ Ø³Ø±ÙŠØ¹ Ù…Ø¹ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø­Ø³Ù†Ø© ========
async function requestQuickWithdrawal(method, amount) {
  const accountInfo = await showCustomPrompt(`Ø£Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ${method} Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ:`, `Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ${method}...`);
  if (accountInfo) {
    await requestWithdrawal(method, accountInfo);
  }
}

// ======== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ========
function loadUserData() {
  const savedData = localStorage.getItem('dobucks_user');
  if (!savedData) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    currentUser = {
      id: generateUserId(),
      username: "player_" + Math.floor(Math.random() * 1000),
      name: "Ù…Ø³ØªØ®Ø¯Ù…",
      email: "user@example.com",
      balance: parseInt(localStorage.getItem("user_balance") || "0"),
      'Referral code': generateReferralCode(),
      Status: "Active",
      HasWithdrawnBefore: false,
      dailyPoints: 0,
      level: parseInt(localStorage.getItem("current_level") || "1"),
      tubes: [],
      referrals: [],
      withdrawalHistory: [],
      totalWithdrawals: 0
    };
    saveUserData();
    return true;
  }
  
  try {
    const data = JSON.parse(savedData);
    currentUser = {
      id: data.id || generateUserId(),
      username: data.username || "player_" + Math.floor(Math.random() * 1000),
      name: data.name || "Ù…Ø³ØªØ®Ø¯Ù…",
      email: data.email || "user@example.com",
      balance: data.balance || parseInt(localStorage.getItem("user_balance") || "0"),
      'Referral code': data['Referral code'] || generateReferralCode(),
      Status: data.Status || "Active",
      HasWithdrawnBefore: data.HasWithdrawnBefore || false,
      dailyPoints: data.dailyPoints || 0,
      level: data.level || parseInt(localStorage.getItem("current_level") || "1"),
      tubes: data.tubes || [],
      referrals: data.referrals || [],
      withdrawalHistory: data.withdrawalHistory || [],
      totalWithdrawals: data.totalWithdrawals || 0
    };
    dailyPoints = data.dailyPoints || 0;
    gameState.level = currentUser.level;
    gameState.tubes = data.tubes || [];
    return true;
  } catch (e) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", e);
    return false;
  }
}

// ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ù…Ø³ØªØ®Ø¯Ù… ÙØ±ÙŠØ¯
function generateUserId() {
  return 'user_' + Math.random().toString(36).substr(2, 9);
}

// ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø©
function generateReferralCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠØ§Ù‹
function saveUserData() {
  if (!currentUser) return;
  const userData = {
    id: currentUser.id,
    username: currentUser.username,
    name: currentUser.name,
    email: currentUser.email,
    balance: currentUser.balance,
    'Referral code': currentUser['Referral code'],
    Status: currentUser.Status,
    HasWithdrawnBefore: currentUser.HasWithdrawnBefore,
    dailyPoints: dailyPoints,
    level: currentUser.level,
    tubes: gameState.tubes,
    referrals: currentUser.referrals || [],
    withdrawalHistory: currentUser.withdrawalHistory || [],
    totalWithdrawals: currentUser.totalWithdrawals || 0
  };
  localStorage.setItem('dobucks_user', JSON.stringify(userData));
  
  // ØªØ­Ø¯ÙŠØ« gameProgress Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  gameProgress.level = currentUser.level;
  gameProgress.balance = currentUser.balance;
  gameProgress.totalPoints = dailyPoints;
  saveGameProgress();
  
  // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª
  updateLevelAndPoints();
}

// ======== Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ© ========
function showNotification(message, type = 'info', duration = 3000) {
  const notif = document.getElementById('notification');
  let bgColor;

  switch(type) {
    case 'success': bgColor = '#4CAF50'; break;
    case 'error': bgColor = '#E53935'; break;
    case 'warning': bgColor = '#FFA000'; break;
    default: bgColor = '#3F51B5';
  }

  notif.style.backgroundColor = bgColor;
  notif.innerHTML = message;
  notif.style.display = 'block';
  notif.style.opacity = '1';

  setTimeout(() => {
    notif.style.opacity = '0';
    setTimeout(() => notif.style.display = 'none', 400);
  }, duration);
}

// ======== ØªØ·Ø¨ÙŠÙ‚ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ========
function applyReferral(referralCode) {
  if (!currentUser) {
    showNotification('âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§ Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø©.', 'warning');
    return;
  }

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ³ØªØ®Ø¯Ù… ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡
  if (currentUser['Referral code'] === referralCode) {
    showNotification('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ!', 'error');
    return;
  }

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠØ³ØªØ®Ø¯Ù… ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„
  if (currentUser.usedReferral) {
    showNotification('âŒ Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„!', 'error');
    return;
  }

  // Ø­ÙØ¸ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
  if (!currentUser.referrals) currentUser.referrals = [];
  
  const referralRecord = {
    code: referralCode,
    date: TODAY,
    bonus: REFERRAL_BONUS
  };
  
  currentUser.referrals.push(referralRecord);
  currentUser.balance += REFERRAL_BONUS;
  gameProgress.balance += REFERRAL_BONUS;
  currentUser.usedReferral = true;
  
  saveUserData();
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø­Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
  if (withdrawalScreen.classList.contains('active')) {
    updateWithdrawalDisplay();
  }
  
  showNotification('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 50 Ù†Ù‚Ø·Ø© ğŸ', 'success');
}

// ======== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø£ÙˆÙ„ Ø¨Ø£ÙˆÙ„ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø­Ø¨ ========
function updateWithdrawalDisplay() {
  if (!currentUser) return;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ - Ø§Ø³ØªØ®Ø¯Ø§Ù… currentUser.balance Ù…Ø¨Ø§Ø´Ø±Ø©
  document.getElementById("current-balance").textContent = currentUser.balance;
  
  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
  const referralsCount = currentUser.referrals ? currentUser.referrals.length : 0;
  document.getElementById('referrals-count').textContent = referralsCount;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
  document.getElementById('current-level').textContent = currentUser.level;
  
  // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
  if (referralScreen.classList.contains('active')) {
    updateReferralDisplay();
  }
}

// ======== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ========
function updateReferralDisplay() {
  if (!currentUser) return;
  
  const referralsCount = currentUser.referrals ? currentUser.referrals.length : 0;
  const totalBonus = referralsCount * REFERRAL_BONUS;
  
  document.getElementById('total-referrals').textContent = referralsCount;
  document.getElementById('referral-bonus').textContent = totalBonus;
  
  // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
  if (currentUser.referrals && currentUser.referrals.length > 0) {
    document.getElementById('referrals-list').innerHTML = currentUser.referrals.map(ref => 
      `<div class="referral-item">
        <span>ÙƒÙˆØ¯: ${ref.code}</span>
        <span>+${ref.bonus} Ù†Ù‚Ø·Ø©</span>
      </div>`
    ).join('');
  }
}

// ======== Ø¹Ù†Ø§ØµØ± DOM ========
const mainScreen = document.getElementById('main-screen');
const referralScreen = document.getElementById('referral-screen');
const referralSystemScreen = document.getElementById('referral-system-screen');
const withdrawalScreen = document.getElementById('withdrawal-screen');
const gameWrap = document.getElementById('game-wrap');
const gameArea = document.getElementById('game-area');
const levelEl = document.getElementById('level');
const pointsEl = document.getElementById('points');
const undoBtn = document.getElementById('undo-btn');
const restartBtn = document.getElementById('restart-btn');
const winMsg = document.getElementById('win-message');
const winStats = document.getElementById('win-stats');
const continueBtn = document.getElementById('continue-btn');
const closeWin = document.getElementById('close-win');
const startGameBtn = document.getElementById('start-game');
const referralBtn = document.getElementById('referral-btn');
const withdrawBtn = document.getElementById('withdraw-btn');
const backToMainBtn = document.getElementById('back-to-main');
const userReferralCode = document.getElementById('user-referral-code');
const referralsList = document.getElementById('referrals-list');
const backToMainFromGameBtn = document.getElementById('back-to-main-from-game');
const referralSystemBtn = document.getElementById('referral-system-btn');
const backToMainFromReferralBtn = document.getElementById('back-to-main-from-referral');
const backToMainFromWithdrawalBtn = document.getElementById('back-to-main-from-withdrawal');
const currentBalanceEl = document.getElementById('current-balance');
const referralsCountEl = document.getElementById('referrals-count');
const totalReferralsEl = document.getElementById('total-referrals');
const referralBonusEl = document.getElementById('referral-bonus');
const internetCheck = document.getElementById('internet-check');
const retryConnectionBtn = document.getElementById('retry-connection');

// ======== Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø§Øª ========
// Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
startGameBtn.addEventListener('click', () => {
  if (!checkInternet()) return;
  
  mainScreen.classList.remove('active');
  gameWrap.style.display = 'flex';
  render();
});

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
referralBtn.addEventListener('click', showReferralScreen);
backToMainBtn.addEventListener('click', () => {
  referralScreen.classList.remove('active');
  mainScreen.classList.add('active');
});

// Ù†Ø¸Ø§Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
referralSystemBtn.addEventListener('click', () => {
  if (!checkInternet()) return;
  
  mainScreen.classList.remove('active');
  referralSystemScreen.classList.add('active');
});

backToMainFromReferralBtn.addEventListener('click', () => {
  referralSystemScreen.classList.remove('active');
  mainScreen.classList.add('active');
});

// Ù†Ø¸Ø§Ù… Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡
withdrawBtn.addEventListener('click', showWithdrawalScreen);
backToMainFromWithdrawalBtn.addEventListener('click', () => {
  withdrawalScreen.classList.remove('active');
  mainScreen.classList.add('active');
});

// Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
backToMainFromGameBtn.addEventListener('click', () => {
  gameWrap.style.display = 'none';
  mainScreen.classList.add('active');
  // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬
  saveUserData();
});

// ======== Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ========
function deepCopy(obj) {
  return JSON.parse(JSON.stringify(obj));
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function saveHistory() {
  gameState.history.push({
    tubes: deepCopy(gameState.tubes),
    moves: gameState.moves
  });
  
  if (gameState.history.length > 80) {
    gameState.history.shift();
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
  saveState({
    tubes: deepCopy(gameState.tubes),
    moves: gameState.moves,
    level: gameState.level
  });
  
  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
  saveUserData();
  
  updateUI();
}

function saveState(state) { 
  gameHistory.push(JSON.stringify(state)); 
}

function undoGame() { 
  if (gameHistory.length === 0) return null;
  return gameHistory.pop(); 
}

function restartGame(initialState) { 
  gameHistory = []; 
  return initialState; 
}

function generateLevel(level) {
  const baseColors = 3;
  const maxColors = 8;
  const colorCount = Math.min(baseColors + Math.floor(level / 2), maxColors);
  const baseTubes = colorCount + 2;
  const extraTubes = Math.floor(level / 3);
  const tubeCount = Math.min(baseTubes + extraTubes, 12);
  
  const shuffledColors = shuffle([...COLORS]);
  const levelColors = shuffledColors.slice(0, colorCount);
  const liquids = [];
  
  for (let i = 0; i < colorCount; i++) {
    for (let j = 0; j < 4; j++) {
      liquids.push({
        id: i,
        color: levelColors[i],
        hidden: Math.random() < 0.25,
        revealed: false
      });
    }
  }
  
  shuffle(liquids);
  
  let newDistribution = Array.from({length: tubeCount}, () => []);
  let idx = 0;
  
  for (let t = 0; t < colorCount; t++) {
    for (let k = 0; k < 4; k++) {
      newDistribution[t].push(liquids[idx++]);
    }
  }
  
  for (let t = colorCount; t < tubeCount; t++) {
    newDistribution[t] = [];
  }
  
  gameState.tubes = newDistribution;
  gameState.selectedTube = null;
  gameState.history = [];
  gameState.moves = 0;
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
  gameHistory = [];
  saveHistory();
}

function render() {
  gameArea.innerHTML = '';
  
  gameState.tubes.forEach((tube, i) => {
    const tubeEl = document.createElement('div');
    tubeEl.className = 'tube';
    tubeEl.dataset.index = i;
    
    tube.forEach((liq, index) => {
      const div = document.createElement('div');
      div.className = 'liquid';
      
      const isHidden = liq.hidden && !liq.revealed && index < tube.length - 1;
      
      if (isHidden) {
        div.style.backgroundColor = '#000';
        div.textContent = '?';
        div.classList.add('hidden-liquid');
      } else {
        div.style.backgroundColor = liq.color;
        div.textContent = '';
      }
      
      tubeEl.appendChild(div);
    });
    
    for (let e = 0; e < 4 - tube.length; e++) {
      const spacer = document.createElement('div');
      spacer.className = 'liquid';
      spacer.style.background = 'transparent';
      spacer.style.opacity = '0.05';
      tubeEl.appendChild(spacer);
    }
    
    tubeEl.addEventListener('click', () => onTubeClick(i));
    
    if (i === gameState.selectedTube) {
      tubeEl.classList.add('selected');
    }
    
    gameArea.appendChild(tubeEl);
  });
  
  updateUI();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙˆØ² Ø¨Ø¹Ø¯ ÙƒÙ„ Ø­Ø±ÙƒØ© - Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
  if (checkWin()) {
    winMsg.style.display = 'flex';
    winStats.textContent = `ğŸ‰ Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${gameState.level} ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ 1 Ù†Ù‚Ø·Ø©!`;
    
    // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ - Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
    levelCompleted();
    
    recordGameProgress(1); // ØªØ³Ø¬ÙŠÙ„ ØªÙ‚Ø¯Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©
  }
}

async function onTubeClick(index) {
  if (gameState.isAnimating) return;

  const tube = gameState.tubes[index];

  if (gameState.selectedTube === null) {
    if (tube.length > 0) {
      gameState.selectedTube = index;
      render();
    }
  } else {
    if (gameState.selectedTube === index) {
      gameState.selectedTube = null;
      render();
      return;
    }
    
    // Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆÙ† Ø§Ù„Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø®ÙÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ù†Ù‚Ù„
    const srcTube = gameState.tubes[gameState.selectedTube];
    if (srcTube.length > 0) {
      const topLiquid = srcTube[srcTube.length - 1];
      if (topLiquid.hidden && !topLiquid.revealed) {
        // ÙƒØ´Ù Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø®ÙÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ù†Ù‚Ù„
        topLiquid.revealed = true;
        render();
        
        // Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù„ÙˆÙ† Ù‚Ø¨Ù„ Ø§Ù„Ù†Ù‚Ù„
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    }

    if (canPour(gameState.selectedTube, index)) {
      performPour(gameState.selectedTube, index);
    } else {
      flashInvalid(index);
      gameState.selectedTube = null;
      render();
    }
  }
}

function canPour(src, dst) {
  const A = gameState.tubes[src];
  const B = gameState.tubes[dst];
  
  if (!A.length || B.length >= 4) return false;
  
  const topIdA = A[A.length - 1].id;
  return B.length === 0 || topIdA === B[B.length - 1].id;
}

function countTopSame(tube) {
  if (!tube.length) return 0;
  
  const topId = tube[tube.length - 1].id;
  let c = 0;
  
  for (let i = tube.length - 1; i >= 0; i--) {
    if (tube[i].id === topId) {
      c++;
    } else {
      break;
    }
  }
  
  return c;
}

// ======== ÙƒØ´Ù Ø§Ù„Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø®ÙÙŠ Ø¨Ø¹Ù„Ø§Ù…Ø© Ø§Ø³ØªÙÙ‡Ø§Ù… ========
function performPour(fromIdx, toIdx) {
  saveHistory();
  
  const from = gameState.tubes[fromIdx];
  const to = gameState.tubes[toIdx];
  const topSame = countTopSame(from);
  const canAccept = 4 - to.length;
  const toMove = Math.min(topSame, canAccept);
  const moved = [];
  
  for (let i = 0; i < toMove; i++) {
    moved.push(from.pop());
  }
  
  for (let i = moved.length - 1; i >= 0; i--) {
    to.push(moved[i]);
  }
  
  // ======== ÙƒØ´Ù Ø§Ù„Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø®ÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ ========
  // Ù„Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù„ Ø§Ù„Ù„ÙŠ ØªØ­Øª ÙƒØ§Ù† Ù…Ø®ÙÙŠ
  if (from.length > 0) {
    const nextLiquid = from[from.length - 1];
    if (nextLiquid && nextLiquid.hidden && !nextLiquid.revealed) {
      nextLiquid.revealed = true;
      showNotification('âœ¨ ØªÙ… ÙƒØ´Ù Ù„ÙˆÙ† Ø§Ù„Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„!', 'info');
    }
  }
  
  gameState.tubes.forEach(tube => {
    if (tube.length > 0) {
      const topLiquid = tube[tube.length - 1];
      if (topLiquid.hidden && !topLiquid.revealed) {
        topLiquid.revealed = true;
      }
    }
  });
  
  gameState.moves++;
  gameState.selectedTube = null;
  render();
}

function flashInvalid(idx) {
  const el = document.querySelector(`.tube[data-index="${idx}"]`);
  if (!el) return;
  
  el.animate([
    {transform: 'translateY(0)'},
    {transform: 'translateY(-8px)'},
    {transform: 'translateY(0)'}
  ], {duration: 260});
}

function checkWin() {
  return gameState.tubes.every(t => {
    if (!t.length) return true;
    if (t.length !== 4) return false;
    const id0 = t[0].id;
    return t.every(x => x.id === id0);
  });
}

function updateUI() {
  levelEl.textContent = gameState.level;
  // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  pointsEl.textContent = currentUser ? currentUser.balance : 0;
  undoBtn.disabled = gameState.history.length === 0 || gameState.isAnimating;
}

// ======== Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© ========
undoBtn.addEventListener('click', () => {
  if (gameState.isAnimating) return;
  
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© undoGame
  const prevState = undoGame();
  if (prevState) {
    const state = JSON.parse(prevState);
    gameState.tubes = state.tubes;
    gameState.moves = state.moves;
    gameState.level = state.level || gameState.level;
  } else if (gameState.history.length > 0) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
    const prev = gameState.history.pop();
    if (!prev) return;
    
    gameState.tubes = deepCopy(prev.tubes);
    gameState.moves = prev.moves;
  } else {
    return;
  }
  
  gameState.selectedTube = null;
  render();
  updateUI();
});

restartBtn.addEventListener('click', () => {
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© restartGame
  restartGame({
    tubes: [],
    moves: 0,
    level: gameState.level
  });
  
  generateLevel(gameState.level);
  render();
});

// ======== Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆÙŠÙŠÙ† ========
continueBtn.addEventListener('click', () => {
  // Ø¥Ø²Ø§Ù„Ø© Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù…Ù† Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡Ø§ ØªØªÙ… Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ levelCompleted()
  // ÙÙ‚Ø· Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ
  generateLevel(gameState.level);
  winMsg.style.display = 'none';
  render();
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  updateLevelAndPoints();
});

closeWin.addEventListener('click', () => {
  winMsg.style.display = 'none';
});

// ======== Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· ========
function updatePoints(p) {
  // ØªØ­Ø¯ÙŠØ«: Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
  if (dailyPoints + p <= MAX_DAILY_POINTS) {
    dailyPoints += p;
    // ØªØ­Ø¯ÙŠØ« currentUser.balance Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† dailyPoints ÙÙ‚Ø·
    if (currentUser) {
      currentUser.balance += p;
    }
    updateUserPoints(p);
  }
}

function updateUserPoints(p) {
  if (!currentUser) return;
  
  // ØªØ­Ø¯ÙŠØ«: Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
  // currentUser.balance ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ÙÙŠ updatePoints
  gameProgress.balance = currentUser.balance;
  currentUser.dailyPoints = dailyPoints;
  gameProgress.totalPoints = dailyPoints;
  
  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
  saveUserData();
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø­Ø¨ Ø£ÙˆÙ„ Ø¨Ø£ÙˆÙ„
  updateWithdrawalDisplay();
  
  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©
  updateUI();
}

// ØªØ³Ø¬ÙŠÙ„ ØªÙ‚Ø¯Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©
function recordGameProgress(pointsEarned) {
  if (!currentUser) return;
  
  // ØªØ­Ø¯ÙŠØ«: Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
  // currentUser.balance ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ÙÙŠ updatePoints
  gameProgress.balance = currentUser.balance;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø­Ø¨ Ø£ÙˆÙ„ Ø¨Ø£ÙˆÙ„
  updateWithdrawalDisplay();
  
  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
  saveUserData();
}

// ======== Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© ========
async function showReferralScreen() {
  if (!checkInternet()) return;
  
  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
  mainScreen.classList.remove('active');
  gameWrap.style.display = 'none';
  
  // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
  referralScreen.classList.add('active');
  
  // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ Ø¨Ø£ÙˆÙ„
  updateReferralDisplay();
}

// ======== Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø­Ø³Ù†Ø© ========
function showWithdrawalScreen() {
  if (!checkInternet()) return;
  
  console.log("Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø­Ø¨...");
  
  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
  mainScreen.classList.remove('active');
  gameWrap.style.display = 'none';
  referralScreen.classList.remove('active');
  referralSystemScreen.classList.remove('active');
  
  // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø­Ø¨
  withdrawalScreen.classList.add('active');
  
  // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø£ÙˆÙ„ Ø¨Ø£ÙˆÙ„
  updateWithdrawalDisplay();
  
  // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨
  loadWithdrawalStatus();
}

// ======== ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ========
function updateGameUI() {
  const user = loadUserLocal();
  if (!user) return;

  const pointsElement = document.getElementById("points-display");
  const levelElement = document.getElementById("level-display");
  const balanceElement = document.getElementById("balance-display");
  const levelWithdraw = document.getElementById("withdraw-level-display");

  if (pointsElement) pointsElement.textContent = user.points || 0;
  if (levelElement) levelElement.textContent = "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " + (user.level || 1);
  if (balanceElement) balanceElement.textContent = user.balance || 0;
  if (levelWithdraw) levelWithdraw.textContent = "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ: " + (user.level || 1);
}

// ========= Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© =========
window.addEventListener("load", async () => {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£ÙˆÙ„Ø§Ù‹
  if (!checkInternet()) {
    return;
  }
  
  let user = loadUserLocal();

  if (user && user.email) {
    const serverUser = await loadUserFromBaserow(user.email);

    if (serverUser) {
      if (new Date(serverUser.last_update) > new Date(user.last_update || 0)) {
        saveUserLocal({
          email: serverUser.user_email,
          name: serverUser.username,
          level: serverUser.level,
          points: serverUser.points,
          referrals: serverUser.referrals,
          balance: serverUser.balance,
          last_update: serverUser.last_update
        });
      } else {
        saveUserToBaserow(user);
      }
    } else {
      saveUserToBaserow(user);
    }

    updateGameUI();
  } else {
    // Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
    const newUser = {
      email: "guest_" + Date.now() + "@dobucks.local",
      name: "Ø¶ÙŠÙ",
      level: 1,
      points: 0,
      referrals: 0,
      balance: 0,
      last_update: new Date().toISOString()
    };
    saveUserLocal(newUser);
    saveUserToBaserow(newUser);
    updateGameUI();
  }
  
  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  loadUserData();
  loadGameProgress();
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¹Ù„Ù…Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
  handleReferralParameter();
  
  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  updateUI();
  updateLevelAndPoints(); // â† ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ù…Ù† updatePointsDisplay Ø¥Ù„Ù‰ updateLevelAndPoints
  
  // âœ… ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨
  setInterval(() => {
    if (withdrawalScreen.classList.contains('active')) {
      loadWithdrawalStatus(true);
    }
  }, 60000);
});

// ======== Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙ‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨ ========
window.addEventListener('offline', () => {
  showNotification("âš ï¸ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù† ØªØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†.", 'error');
  showInternetError();
});

window.addEventListener('online', () => {
  showNotification("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", 'success');
  hideInternetError();
});

// ======== Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ========
retryConnectionBtn.addEventListener('click', () => {
  if (navigator.onLine) {
    hideInternetError();
    location.reload();
  } else {
    showNotification("âŒ Ù„Ø§ ÙŠØ²Ø§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù…Ù‚Ø·ÙˆØ¹Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.", 'error');
  }
});

// ======== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ========
generateLevel(gameState.level);
render();
</script>
</body>
</html>